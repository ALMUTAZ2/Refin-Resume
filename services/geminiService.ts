import { GoogleGenAI, Type } from "@google/genai";
import { AnalysisResult, JobMatchResult, ResumeSection, ImprovedContent } from "../types";

export class GeminiService {
  private genAI: GoogleGenAI;
  
  // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸàÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ± ŸàÿßŸÑŸÖÿ¨ÿßŸÜŸä
  private readonly MODEL_NAME = 'gemini-1.5-flash';

  constructor() {
    const apiKey = (process.env as any).API_KEY;
    if (!apiKey || apiKey.includes("---") || apiKey.length < 10) {
      throw new Error("API Key Invalid: Please check your .env.local file.");
    }
    this.genAI = new GoogleGenAI({ apiKey });
  }

  // ==========================================
  // üõ†Ô∏è Helpers (ÿßŸÑÿ®ŸÜŸäÿ© ÿßŸÑÿ™ÿ≠ÿ™Ÿäÿ©)
  // ==========================================

  private async withRetry<T>(operation: () => Promise<T>, retries = 3): Promise<T> {
    for (let i = 0; i < retries; i++) {
      try {
        return await operation();
      } catch (error: any) {
        if (i === retries - 1) throw error;
        // Exponential backoff: 1s, 2s, 4s
        await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i)));
      }
    }
    throw new Error("Network Error");
  }

  private cleanAndParseJSON(text: string): any {
    try {
      let cleanText = text.replace(/```json\s*|\s*```/g, "").trim();
      const firstBrace = cleanText.indexOf('{');
      const lastBrace = cleanText.lastIndexOf('}');
      if (firstBrace !== -1 && lastBrace !== -1) {
        cleanText = cleanText.substring(firstBrace, lastBrace + 1);
      }
      return JSON.parse(cleanText);
    } catch (e) {
      console.error("JSON Parse Failed:", text);
      throw new Error("ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ŸÖŸÜ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.");
    }
  }

  // ==========================================
  // ‚öñÔ∏è Logic: Strict ATS Scoring (ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿßŸÑÿµÿßÿ±ŸÖ)
  // ==========================================
  private calculateATSScore(data: any): number {
    const flags = data?.parsingFlags || {};
    
    // 1. Kill Switch: ÿ£ÿÆÿ∑ÿßÿ° ŸÇÿßÿ™ŸÑÿ© ÿ™ÿ¨ÿπŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°
    if (flags.isGraphic || flags.hasColumns || flags.hasTables) {
      return 35; // ÿ±ÿ≥Ÿàÿ® ŸÅŸàÿ±Ÿä
    }

    // 2. Fatal Lite Penalties: ÿ£ÿÆÿ∑ÿßÿ° ŸáŸäŸÉŸÑŸäÿ©
    let penalty = 0;
    if (!flags.hasStandardSectionHeaders) penalty += 20; 
    if (flags.contactInfoInHeader) penalty += 15;

    // 3. Positive Scoring
    const metrics = data?.metrics || {};
    const totalBullets = Math.max(metrics.totalBulletPoints || 1, 1);
    const bulletsWithNumbers = metrics.bulletsWithMetrics || 0;
    
    // Impact (40%): ŸÑÿ∫ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
    const metricsRatio = Math.min(bulletsWithNumbers / totalBullets, 0.4) / 0.4; 
    const impactScore = metricsRatio * 40;

    // Skills (30%): ÿπÿØÿØ ÿßŸÑŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÇŸÜŸäÿ©
    const hardSkillsCount = data?.hardSkillsFound?.length || 0;
    const skillsScore = Math.min(hardSkillsCount, 8) / 8 * 30;

    // Structure (20%): Ÿàÿ¨ŸàÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    const sections = data?.structuredSections?.map((s: any) => s.title.toLowerCase()) || [];
    let structurePoints = 0;
    if (sections.some((s: string) => s.includes('experience') || s.includes('work'))) structurePoints += 5;
    if (sections.some((s: string) => s.includes('education'))) structurePoints += 5;
    if (sections.some((s: string) => s.includes('skill'))) structurePoints += 5;
    if (sections.length >= 4) structurePoints += 5;
    
    // Formatting (10%): ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑŸÜÿµŸäÿ© ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ©
    const minorIssues = (data?.formattingIssues?.length || 0);
    const formattingScore = Math.max(0, 10 - (minorIssues * 2));

    // 4. Final Calculation (ŸÖŸÜÿπ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≥ÿßŸÑÿ®ÿ©)
    const rawScore = impactScore + skillsScore + structurePoints + formattingScore;
    const finalScore = Math.max(0, rawScore - penalty);
    
    return Math.round(Math.max(10, Math.min(100, finalScore)));
  }

  // ==========================================
  // üöÄ Core Features (ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©)
  // ==========================================

  async analyzeResume(text: string): Promise<AnalysisResult> {
    // üîç Log for Vercel Debugging
    console.log(`üöÄ STARTING ANALYSIS WITH MODEL: ${this.MODEL_NAME}`);

    const systemInstruction = `
      ROLE: Strict Legacy ATS Parser.
      OBJECTIVE: Detect structural parsing failures.
      
      RULES:
      1. NO INFERENCE: Do not guess roles or skills. If text isn't explicit, ignore it.
      2. BOOLEAN FLAGS ONLY: For 'hasColumns', 'hasTables', 'isGraphic'.
      3. LITERAL EXTRACTION: Copy text exactly found.
      
      OUTPUT: Strict JSON only.
    `;

    return this.withRetry(async () => {
      const response = await this.genAI.models.generateContent({
        model: this.MODEL_NAME, // gemini-1.5-flash
        contents: [{ role: 'user', parts: [{ text: `${systemInstruction}\n\nRESUME RAW TEXT:\n${text}` }] }],
        config: {
          temperature: 0.0, // Zero creativity for accuracy
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              extractedHeadlines: { type: Type.ARRAY, items: { type: Type.STRING }, description: "Job titles explicitly found" },
              
              parsingFlags: {
                type: Type.OBJECT,
                properties: {
                  isGraphic: { type: Type.BOOLEAN },
                  hasColumns: { type: Type.BOOLEAN },
                  hasTables: { type: Type.BOOLEAN },
                  hasStandardSectionHeaders: { type: Type.BOOLEAN },
                  contactInfoInHeader: { type: Type.BOOLEAN }
                },
                required: ["isGraphic", "hasColumns", "hasTables", "hasStandardSectionHeaders", "contactInfoInHeader"]
              },

              hardSkillsFound: { type: Type.ARRAY, items: { type: Type.STRING } },
              softSkillsFound: { type: Type.ARRAY, items: { type: Type.STRING } },
              
              metrics: {
                type: Type.OBJECT,
                properties: {
                  totalBulletPoints: { type: Type.NUMBER },
                  bulletsWithMetrics: { type: Type.NUMBER },
                  sectionCount: { type: Type.NUMBER }
                },
                required: ["totalBulletPoints", "bulletsWithMetrics", "sectionCount"]
              },
              
              formattingIssues: { type: Type.ARRAY, items: { type: Type.STRING } },
              summaryFeedback: { type: Type.STRING },
              structuredSections: {
                type: Type.ARRAY,
                items: {
                  type: Type.OBJECT,
                  properties: { id: { type: Type.STRING }, title: { type: Type.STRING }, content: { type: Type.STRING } },
                  required: ["id", "title", "content"]
                }
              }
            }
          }
        }
      });

      const data = this.cleanAndParseJSON(response.text || "{}");
      
      const sanitized: AnalysisResult = {
        detectedRole: data.extractedHeadlines?.[0] || "", 
        parsingFlags: data.parsingFlags || { isGraphic: false, hasColumns: false, hasTables: false, hasStandardSectionHeaders: true, contactInfoInHeader: false },
        hardSkillsFound: data.hardSkillsFound || [],
        softSkillsFound: data.softSkillsFound || [],
        missingHardSkills: [], // ŸÅÿßÿ±ÿ∫ ŸÅŸä ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿπÿßŸÖ
        metrics: {
          totalBulletPoints: data.metrics?.totalBulletPoints ?? 0,
          bulletsWithMetrics: data.metrics?.bulletsWithMetrics ?? 0,
          weakVerbsCount: 0, 
          sectionCount: data.metrics?.sectionCount ?? 0
        },
        formattingIssues: data.formattingIssues || [],
        criticalErrors: [], // Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØŸáÿß ŸÅŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        strengths: [],
        weaknesses: [],
        summaryFeedback: data.summaryFeedback || "Analysis Complete",
        structuredSections: data.structuredSections || [],
      };

      sanitized.overallScore = this.calculateATSScore(sanitized);
      return sanitized;
    });
  }

  // --- Elastic Optimization (500-700 Words Logic) ---
  async bulkImproveATS(sections: ResumeSection[]): Promise<Record<string, string>> {
    const currentTotalWords = sections.reduce((acc, section) => acc + section.content.trim().split(/\s+/).length, 0);
    let targetWords = currentTotalWords;
    let strategy = "OPTIMIZE"; 

    if (currentTotalWords < 500) { targetWords = 520; strategy = "EXPAND"; } 
    else if (currentTotalWords > 700) { targetWords = 680; strategy = "CONDENSE"; }

    const weights: Record<string, number> = { 'experience': 0.65, 'projects': 0.15, 'summary': 0.10, 'education': 0.05, 'skills': 0.05 };

    const compressedInput = sections.map(s => {
      const type = s.title.toLowerCase();
      let weight = weights['experience']; 
      if (type.includes('summary')) weight = weights['summary'];
      else if (type.includes('project')) weight = weights['projects'];
      else if (type.includes('education')) weight = weights['education'];
      else if (type.includes('skill')) weight = weights['skills'];

      const sectionTarget = Math.round(targetWords * weight);
      return { id: s.id, type: s.title, content: s.content, instruction: `Strategy: ${strategy}. Target ~${sectionTarget} words.` };
    });

    return this.withRetry(async () => {
      const response = await this.genAI.models.generateContent({
        model: this.MODEL_NAME,
        contents: [{ role: 'user', parts: [{ text: `CONTEXT: Resume Rewriter. CONSTRAINT: 500-700 Words. STRATEGY: ${strategy}. INPUT: ${JSON.stringify(compressedInput)} OUTPUT: JSON Mapping {id: improved_html_content}` }] }],
        config: { 
          temperature: 0.45,
          responseMimeType: "application/json",
          responseSchema: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, improvedContent: { type: Type.STRING } }, required: ["id", "improvedContent"] } }
        }
      });
      const data = this.cleanAndParseJSON(response.text || "[]");
      const mapping: Record<string, string> = {};
      data.forEach((item: any) => mapping[item.id] = item.improvedContent);
      return mapping;
    });
  }

  async improveSection(title: string, content: string): Promise<ImprovedContent> {
    return this.withRetry(async () => {
      const response = await this.genAI.models.generateContent({
        model: this.MODEL_NAME,
        contents: [{ role: 'user', parts: [{ text: `Rewrite section "${title}". 1. Professional: Executive tone. 2. ATS: Keyword-rich. Content: ${content}` }] }],
        config: {
          temperature: 0.5,
          responseMimeType: "application/json",
          responseSchema: { type: Type.OBJECT, properties: { professional: { type: Type.STRING }, atsOptimized: { type: Type.STRING } }, required: ["professional", "atsOptimized"] }
        }
      });
      return this.cleanAndParseJSON(response.text || "{}");
    });
  }

  // --- Weighted Job Match (Core vs Secondary) ---
  async matchJobDescription(resumeText: string, sections: ResumeSection[], jobDescription: string): Promise<JobMatchResult> {
    return this.withRetry(async () => {
      const cleanResume = resumeText.substring(0, 15000); 
      const cleanJD = jobDescription.substring(0, 5000);

      const response = await this.genAI.models.generateContent({
        model: this.MODEL_NAME,
        contents: [{ role: 'user', parts: [{ text: `
          TASK: Strict ATS Job Match.
          JD: ${cleanJD}
          RESUME: ${cleanResume}
          STEPS:
          1. Extract JD Keywords -> Categorize: "CORE" (Must-have) vs "SECONDARY" (Nice-to-have).
          2. LITERAL MATCHING against Resume (No inference).
          3. Rewrite "Experience" & "Summary" to include missing CORE keywords.
        ` }] }],
        config: {
          temperature: 0.2, 
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              matchedCoreKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
              missingCoreKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
              matchedSecondaryKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
              missingSecondaryKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
              matchFeedback: { type: Type.STRING },
              tailoredSections: {
                type: Type.ARRAY,
                items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, title: { type: Type.STRING }, content: { type: Type.STRING } }, required: ["id", "title", "content"] }
              }
            }
          }
        }
      });
      
      const data = this.cleanAndParseJSON(response.text || "{}");

      // Weighted Calculation: Core=3, Secondary=1
      const coreMatch = data.matchedCoreKeywords?.length || 0;
      const coreMissing = data.missingCoreKeywords?.length || 0;
      const secMatch = data.matchedSecondaryKeywords?.length || 0;
      const secMissing = data.missingSecondaryKeywords?.length || 0;

      const totalWeightedPoints = ((coreMatch + coreMissing) * 3) + (secMatch + secMissing);
      const earnedWeightedPoints = (coreMatch * 3) + secMatch;

      const calculatedPercentage = totalWeightedPoints > 0 
        ? Math.round((earnedWeightedPoints / totalWeightedPoints) * 100) 
        : 0;

      // ÿØŸÖÿ¨ ÿßŸÑŸÖÿµŸÅŸàŸÅÿßÿ™ ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
      return { 
        matchingKeywords: [...(data.matchedCoreKeywords || []), ...(data.matchedSecondaryKeywords || [])],
        missingKeywords: [...(data.missingCoreKeywords || []), ...(data.missingSecondaryKeywords || [])],
        matchFeedback: data.matchFeedback,
        tailoredSections: data.tailoredSections,
        matchPercentage: calculatedPercentage 
      };
    });
  }
}
                                                                                                                                                                                                                                                                                                                                                                                            3. LITERAL EXTRACTION: Copy text exactly found.
                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                        OUTPUT: Strict JSON only.
                                                                                                                                                                                                                                                                                                                                                                                                            `;

                                                                                                                                                                                                                                                                                                                                                                                                                return this.withRetry(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                      const response = await this.genAI.models.generateContent({
                                                                                                                                                                                                                                                                                                                                                                                                                              model: this.MODEL_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                      contents: [{ role: 'user', parts: [{ text: `${systemInstruction}\n\nRESUME RAW TEXT:\n${text}` }] }],
                                                                                                                                                                                                                                                                                                                                                                                                                                              config: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        temperature: 0.0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  responseMimeType: "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            responseSchema: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type: Type.OBJECT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    properties: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  extractedHeadlines: { type: Type.ARRAY, items: { type: Type.STRING }, description: "Job titles found in header" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              parsingFlags: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              type: Type.OBJECT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              properties: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                isGraphic: { type: Type.BOOLEAN },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  hasColumns: { type: Type.BOOLEAN },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    hasTables: { type: Type.BOOLEAN },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      hasStandardSectionHeaders: { type: Type.BOOLEAN },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        contactInfoInHeader: { type: Type.BOOLEAN }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        required: ["isGraphic", "hasColumns", "hasTables", "hasStandardSectionHeaders", "contactInfoInHeader"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    hardSkillsFound: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  softSkillsFound: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              metrics: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              type: Type.OBJECT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              properties: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                totalBulletPoints: { type: Type.NUMBER },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  bulletsWithMetrics: { type: Type.NUMBER },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sectionCount: { type: Type.NUMBER }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    required: ["totalBulletPoints", "bulletsWithMetrics", "sectionCount"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              formattingIssues: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          summaryFeedback: { type: Type.STRING },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        structuredSections: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type: Type.ARRAY,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        items: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          type: Type.OBJECT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            properties: { id: { type: Type.STRING }, title: { type: Type.STRING }, content: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              required: ["id", "title", "content"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const data = this.cleanAndParseJSON(response.text || "{}");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const sanitized: AnalysisResult = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿÆÿßŸÖ ŸÅŸÇÿ∑ÿå ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿ™ŸÇÿ±ÿ± ŸÉŸäŸÅ ÿ™ÿπÿ±ÿ∂Ÿáÿß
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  detectedRole: data.extractedHeadlines?.[0] || "", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          parsingFlags: data.parsingFlags || { isGraphic: false, hasColumns: false, hasTables: false, hasStandardSectionHeaders: true, contactInfoInHeader: false },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  hardSkillsFound: data.hardSkillsFound || [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          softSkillsFound: data.softSkillsFound || [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Removed missingHardSkills from general scan
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  missingHardSkills: [], 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          metrics: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    totalBulletPoints: data.metrics?.totalBulletPoints ?? 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              bulletsWithMetrics: data.metrics?.bulletsWithMetrics ?? 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        weakVerbsCount: 0, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  sectionCount: data.metrics?.sectionCount ?? 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          formattingIssues: data.formattingIssues || [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ŸÜÿ™ÿ±ŸÉ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ŸÅÿßÿ±ÿ∫ÿ© ŸáŸÜÿßÿå ŸàÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© ÿ™ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÄ Flags
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  criticalErrors: [], 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  strengths: [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          weaknesses: [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  summaryFeedback: data.summaryFeedback || "Analysis Complete",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          structuredSections: data.structuredSections || [],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      sanitized.overallScore = this.calculateATSScore(sanitized);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return sanitized;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // --- Elastic Optimization ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async bulkImproveATS(sections: ResumeSection[]): Promise<Record<string, string>> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const currentTotalWords = sections.reduce((acc, section) => acc + section.content.trim().split(/\s+/).length, 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let targetWords = currentTotalWords;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let strategy = "OPTIMIZE"; 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (currentTotalWords < 500) { targetWords = 520; strategy = "EXPAND"; } 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          else if (currentTotalWords > 700) { targetWords = 680; strategy = "CONDENSE"; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const weights: Record<string, number> = { 'experience': 0.65, 'projects': 0.15, 'summary': 0.10, 'education': 0.05, 'skills': 0.05 };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const compressedInput = sections.map(s => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const type = s.title.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let weight = weights['experience']; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (type.includes('summary')) weight = weights['summary'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          else if (type.includes('project')) weight = weights['projects'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else if (type.includes('education')) weight = weights['education'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      else if (type.includes('skill')) weight = weights['skills'];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const sectionTarget = Math.round(targetWords * weight);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return { id: s.id, type: s.title, content: s.content, instruction: `Strategy: ${strategy}. Target ~${sectionTarget} words.` };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return this.withRetry(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const response = await this.genAI.models.generateContent({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model: this.MODEL_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                contents: [{ role: 'user', parts: [{ text: `CONTEXT: Resume Rewriter. CONSTRAINT: 500-700 Words. STRATEGY: ${strategy}. INPUT: ${JSON.stringify(compressedInput)} OUTPUT: JSON Mapping {id: improved_html_content}` }] }],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        config: { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  temperature: 0.45,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            responseMimeType: "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      responseSchema: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, improvedContent: { type: Type.STRING } }, required: ["id", "improvedContent"] } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const data = this.cleanAndParseJSON(response.text || "[]");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const mapping: Record<string, string> = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      data.forEach((item: any) => mapping[item.id] = item.improvedContent);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return mapping;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async improveSection(title: string, content: string): Promise<ImprovedContent> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return this.withRetry(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const response = await this.genAI.models.generateContent({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      model: this.MODEL_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              contents: [{ role: 'user', parts: [{ text: `Rewrite section "${title}". 1. Professional: Executive tone. 2. ATS: Keyword-rich. Content: ${content}` }] }],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      config: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                temperature: 0.5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          responseMimeType: "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    responseSchema: { type: Type.OBJECT, properties: { professional: { type: Type.STRING }, atsOptimized: { type: Type.STRING } }, required: ["professional", "atsOptimized"] }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return this.cleanAndParseJSON(response.text || "{}");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // --- Weighted Job Match ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async matchJobDescription(resumeText: string, sections: ResumeSection[], jobDescription: string): Promise<JobMatchResult> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return this.withRetry(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const cleanResume = resumeText.substring(0, 15000); 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const cleanJD = jobDescription.substring(0, 5000);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const response = await this.genAI.models.generateContent({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model: this.MODEL_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        contents: [{ role: 'user', parts: [{ text: `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  TASK: Strict ATS Job Match.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            JD: ${cleanJD}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      RESUME: ${cleanResume}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                STEPS:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          1. Extract JD Keywords -> Categorize: "CORE" (Must-have) vs "SECONDARY" (Nice-to-have).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    2. LITERAL MATCHING against Resume (No inference).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              3. Rewrite "Experience" & "Summary" to include missing CORE keywords.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ` }] }],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              config: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        temperature: 0.2, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  responseMimeType: "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            responseSchema: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type: Type.OBJECT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    properties: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  matchedCoreKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                missingCoreKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              matchedSecondaryKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            missingSecondaryKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          matchFeedback: { type: Type.STRING },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tailoredSections: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type: Type.ARRAY,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, title: { type: Type.STRING }, content: { type: Type.STRING } }, required: ["id", "title", "content"] }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const data = this.cleanAndParseJSON(response.text || "{}");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Weighted Calculation: Core=3, Secondary=1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const coreMatch = data.matchedCoreKeywords?.length || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const coreMissing = data.missingCoreKeywords?.length || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const secMatch = data.matchedSecondaryKeywords?.length || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const secMissing = data.missingSecondaryKeywords?.length || 0;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const totalWeightedPoints = ((coreMatch + coreMissing) * 3) + (secMatch + secMissing);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const earnedWeightedPoints = (coreMatch * 3) + secMatch;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const calculatedPercentage = totalWeightedPoints > 0 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ? Math.round((earnedWeightedPoints / totalWeightedPoints) * 100) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      : 0;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchingKeywords: [...(data.matchedCoreKeywords || []), ...(data.matchedSecondaryKeywords || [])],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            missingKeywords: [...(data.missingCoreKeywords || []), ...(data.missingSecondaryKeywords || [])],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchFeedback: data.matchFeedback,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tailoredSections: data.tailoredSections,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchPercentage: calculatedPercentage 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
